**
 * Script responsible for loading EBR Shops into GeoJSON format and handling all Shop functions
 *  */
let map; 
let tiles;
let currentLocation;
let geoJsonLayer;
let markers;
let infoWindow;
const placement = "map";

/* DISABLIING until further notice
 * let NAV_PREFIX = '';
 * if ((navigator.platform.indexOf("iPhone") != -1) || 
 * (navigator.platform.indexOf("iPad") != -1) || 
 * (navigator.platform.indexOf("iPod") != -1)) {
 *     NAV_PREFIX = "maps://maps.google.com/maps?daddr=";
 *     } else {
 *         NAV_PREFIX = "https://maps.google.com/maps?daddr=";
 *         }
 *         */

/**
 *  * This is where it all begins! The Maps API embed script calls this function as its callback. 
 *   * 
 *    * Attempts to load a search location from storage and then geolocates.
 *     * 
 *      * Wrapped in a 1.5-second timeout to allow the page to load first
 *       * 
 *        */
 function initShopsDirectoryMap() {
    if (document.getElementById('osm-map') == null) {
        return;
    }

    let locationSearchString = getLocationSearchString();
    geolocate(locationSearchString, true);

    let params = new  URLSearchParams(window.location.search);
    let brand = '';
    if (params.has('brand')) {
        brand = params.get('brand');
    }
    // Get the shops
    //     fetch(DASHBOARD_SHOPS_MAP_ENDPOINT + '?brand=' + brand).then(response => {
    //             return response.json();
    //                 }).then(data => {
    //                         loadGeoJsonData(data);
    //                             });
    //                                 setTimeout(function () {
    //                                         document.getElementById('map-location').value = locationSearchString;
    //                                                 if (window.location.href.includes('shop-directory')) {
    //                                                             document.getElementById('brand-filter').value = brand;
    //                                                                     }
    //                                                                         }, 500);
    //                                                                          }
    //
    //                                                                           /**
    //                                                                             * 
    //                                                                               * Loads a search string from localStorage
    //                                                                                 */
    //                                                                                  function getLocationSearchString() {
    //                                                                                      let search = localStorage.getItem('location');
    //
    //                                                                                          if (search) {
    //                                                                                                  return search;
    //                                                                                                      } else {
    //                                                                                                              return '';
    //                                                                                                                  }
    //                                                                                                                   }
    //
    //                                                                                                                    /**
    //                                                                                                                      * Geolocates and sets the current location variable
    //                                                                                                                        */
    //                                                                                                                         function geolocate(locationSearchString, initialize=false) {
    //                                                                                                                             fetch(DASHBOARD_GEOLOCATE_ENDPOINT + '?location=' + locationSearchString).then(response => {
    //                                                                                                                                     return response.json();
    //                                                                                                                                         }).then(data => {
    //                                                                                                                                                 currentLocation = data;
    //                                                                                                                                                         if (initialize) {
    //                                                                                                                                                                     initMap();
    //                                                                                                                                                                             }
    //                                                                                                                                                                                 });
    //                                                                                                                                                                                  }
    //
    //                                                                                                                                                                                   /**
    //                                                                                                                                                                                     * Create html to use in a popup for a given shop
    //                                                                                                                                                                                       */
    //                                                                                                                                                                                        function compilePopupHtml(feature) {
    //                                                                                                                                                                                             return '<div class="shop-wrapper">'+
    //                                                                                                                                                                                                  '<div class="shop">' +
    //                                                                                                                                                                                                       '<div class="shop-title">' +
    //                                                                                                                                                                                                            '<h4 id="firstHeading" class="firstHeading">' + feature.properties.name + '</h4>'+
    //                                                                                                                                                                                                                 '</div>' + // End shop-title
    //                                                                                                                                                                                                                      '<div class="address">'+feature.properties.display_address + '</div>' +
    //                                                                                                                                                                                                                           '<div class="contacts">' +
    //
    //                                                                                                                                                                                                                                '<a onclick="trackShopClick(event);" data-id="' + feature.properties.id + '" data-target="website" class="btn btn-default contact" href="' + 
    //                                                                                                                                                                                                                                     feature.properties.website + '" target="_blank" rel="nofollow" noopener>Visit Website <i class="fas fa-external-link"></i></a>'+
    //
    //                                                                                                                                                                                                                                         /* Disabling until further notice
    //                                                                                                                                                                                                                                              '<a onclick="trackShopClick(event);" data-id="' + feature.properties.id + '" data-target="directions" class="btn btn-default contact" href="' + 
    //                                                                                                                                                                                                                                                   NAV_PREFIX + feature.properties.latitude + "," + feature.properties.longitude + '&amp;ll=" target="_blank">Get Directions <i class="fas fa-location-arrow"></i></a>' +
    //                                                                                                                                                                                                                                                        */
    //
    //                                                                                                                                                                                                                                                             '<a onclick="trackShopClick(event);" data-id="' + feature.properties.id + '" data-target="phone" data-phone="' + feature.properties.phone + '" class="btn btn-default contact" id="' + 
    //                                                                                                                                                                                                                                                                  feature.properties.id + '-phone" ' + '">Get Phone Number <i class="fas fa-phone"></i></a>' +
    //
    //                                                                                                                                                                                                                                                                       '</div>' + // End contacts
    //                                                                                                                                                                                                                                                                            '<div class="brands">' + compileBrandsHtml(feature) +'</div>' +
    //                                                                                                                                                                                                                                                                                 '</div>' + // End shop
    //                                                                                                                                                                                                                                                                                      '</div>' // End shop-wrapper
    //                                                                                                                                                                                                                                                                                       }
    //
    //                                                                                                                                                                                                                                                                                        /**
    //                                                                                                                                                                                                                                                                                          * generate HTML for the brands section of a shop popup
    //                                                                                                                                                                                                                                                                                            * @param {Feature} feature 
    //                                                                                                                                                                                                                                                                                              */
    //                                                                                                                                                                                                                                                                                               function compileBrandsHtml(feature) {
    //                                                                                                                                                                                                                                                                                                   let brands = feature.properties.brands;
    //                                                                                                                                                                                                                                                                                                       let html = '';
    //                                                                                                                                                                                                                                                                                                           brands.forEach(function(brand) {
    //                                                                                                                                                                                                                                                                                                                   html = html + '<a class="brand" href="' + getBrandPageUrl(brand) + '" target="_blank"><img src="' + brand.logo_url + '" class="img-fluid brand-image" alt="' + brand.name + '" title="' + brand.name + '"></a>';
    //                                                                                                                                                                                                                                                                                                                       });
    //                                                                                                                                                                                                                                                                                                                           return html;
    //                                                                                                                                                                                                                                                                                                                            }
    //
    //                                                                                                                                                                                                                                                                                                                             /**
    //                                                                                                                                                                                                                                                                                                                               * Generate a permalink to the brand page
    //                                                                                                                                                                                                                                                                                                                                 * @param {Brand} brand 
    //                                                                                                                                                                                                                                                                                                                                   */
    //                                                                                                                                                                                                                                                                                                                                    function getBrandPageUrl(brand) {
    //                                                                                                                                                                                                                                                                                                                                        return window.location.origin + '/brand/' + brand.slug + '/';
    //                                                                                                                                                                                                                                                                                                                                         }
    //
    //                                                                                                                                                                                                                                                                                                                                          /**
    //                                                                                                                                                                                                                                                                                                                                            * Initialize OSM
    //                                                                                                                                                                                                                                                                                                                                              * 
    //                                                                                                                                                                                                                                                                                                                                                * Tiles are served by THE INTERNET
    //                                                                                                                                                                                                                                                                                                                                                  * 
    //                                                                                                                                                                                                                                                                                                                                                    */
    //                                                                                                                                                                                                                                                                                                                                                    function initMap() {
    //                                                                                                                                                                                                                                                                                                                                                        L.Icon.Default.imagePath = SHOPS_ICON_PATH_OSM + '/';
    //                                                                                                                                                                                                                                                                                                                                                            map = L.map('osm-map', {
    //                                                                                                                                                                                                                                                                                                                                                                    gestureHandling: true
    //                                                                                                                                                                                                                                                                                                                                                                        }).setView({lon: currentLocation.lng, lat: currentLocation.lat}, 10); // todo use location but round
    //                                                                                                                                                                                                                                                                                                                                                                            // add the OpenStreetMap tiles
    //                                                                                                                                                                                                                                                                                                                                                                                L.tileLayer('https://api.nettoolkit.com/v1/geo/tiles/{z}/{x}/{y}?key=Kl6P7PQuM7R8y74NgUnTKj6FalVsYzzF0VWHL4Wg', {
    //                                                                                                                                                                                                                                                                                                                                                                                    maxZoom: 19,
    //                                                                                                                                                                                                                                                                                                                                                                                        attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
    //                                                                                                                                                                                                                                                                                                                                                                                            }).addTo(map);
    //
    //                                                                                                                                                                                                                                                                                                                                                                                                // show the scale bar on the lower left corner
    //                                                                                                                                                                                                                                                                                                                                                                                                    L.control.scale().addTo(map);
    //                                                                                                                                                                                                                                                                                                                                                                                                    }
    //
    //                                                                                                                                                                                                                                                                                                                                                                                                    /* Load GeoJSON data into the map */
    //                                                                                                                                                                                                                                                                                                                                                                                                    function loadGeoJsonData(data) {
    //                                                                                                                                                                                                                                                                                                                                                                                                        markers = L.markerClusterGroup({
    //                                                                                                                                                                                                                                                                                                                                                                                                                showCoverageOnHover: false
    //                                                                                                                                                                                                                                                                                                                                                                                                                    });
    //                                                                                                                                                                                                                                                                                                                                                                                                                        
    //                                                                                                                                                                                                                                                                                                                                                                                                                            let geoJsonLayer = L.geoJson(data, {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                    onEachFeature: function (feature, layer) {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                layer.bindPopup(compilePopupHtml(feature));
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                            });
    //
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                markers.addLayer(geoJsonLayer);
    //
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                    map.addLayer(markers);
    //
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                        map.on('popupopen', function(e) {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                var px = map.project(e.target._popup._latlng); // find the pixel location on the map where the popup anchor is
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        px.y -= e.target._popup._container.clientHeight/1.52; // find the height of the popup container, divide by 2, subtract from the Y axis of marker location
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                map.panTo(map.unproject(px),{animate: true}); // pan to new center
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    });
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
    //
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    /* extra actions to run for each feature loaded */
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    function onEachFeature(feature, layer) {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        var marker = L.marker(new L.LatLng(feature.geometry.coordinates[0], feature.geometry.coordinates[1]), { title: feature.properties.name });
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            marker.bindPopup(compilePopupHtml(feature));
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                markers.addLayer(marker);
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // layer.bindPopup(compilePopupHtml(feature));
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
    //
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    function trackShopClick(ev) {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (ev.isTrusted) {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                var event = new CustomEvent('shop-click-event', {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            detail: {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            id: ev.target.dataset.id, 
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            placement: placement, 
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            target: ev.target.dataset.target
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        document.dispatchEvent(event);
    //
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (ev.target.dataset.target == "phone") {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById(String(ev.target.dataset.id) + '-phone').innerHTML = String(ev.target.dataset.phone) + ' <i class="fa fa-phone"></i>';
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        setTimeout(function() {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        document.getElementById(String(ev.target.dataset.id) + '-phone').href = 'tel:' + String(ev.target.dataset.phone);
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }, 500);
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
    //
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                /**
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * Handle searching on enter keypress 
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  */
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  function checkKeyPressed(ele) {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (event.key === 'Enter') {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (ele == 'location') {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          handleNewUserSearch();
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (ele == 'brand') {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      handleNewBrandFilter();
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
    //
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  /* Handle input from this map */
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  function handleNewUserSearch() {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      let newSearchLocation = document.getElementById('map-location').value;
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (newSearchLocation == null || newSearchLocation.length == 0) {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  alert('Please enter a valid location to search for');
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      } else {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              newSearchLocation = formatForApi(newSearchLocation);
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      updateSearchLocation(newSearchLocation);
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              reloadMap();
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
    //
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  /** Handle a new brand filter input */
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  function handleNewBrandFilter() {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      let newBrandFilter = document.getElementById('brand-filter').value;
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          newBrandFilter = newBrandFilter.replace(/ /g, "-");
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (newBrandFilter == null || newBrandFilter.length == 0) {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      alert('Please enter a valid brand name to filter by');
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          } else {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  let params = new  URLSearchParams(window.location.search);
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          params.set('brand', newBrandFilter);
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  window.history.pushState(null, null, '?' + params);
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          reloadShops(params);
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
    //
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              /* reset to no query params */
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              function resetBrandFilter() {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  window.history.pushState(null, null, '?');
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      document.getElementById('brand-filter').value = '';
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          reloadShops();
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
    //
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          /* live reload shops without refreshing page */
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          function reloadShops(params='') {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              markers.clearLayers();
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  fetch(DASHBOARD_SHOPS_MAP_ENDPOINT + '?' + params).then(response => {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return response.json();
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }).then(data => {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      loadGeoJsonData(data);
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          });
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
    //
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          /**
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Update the map center after a brief delay
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            */
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            function reloadMap() {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                setTimeout(function() {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        map.setView(currentLocation, 10);
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }, 500);
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
    //
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            /**
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * replace spaces with dashes
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * @param {string} search 
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               */
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               function formatForApi(search) {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   search = search.replace(/\s+/g, '-');
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       return search;
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }
    //
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       /**
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * replace spaces with dashes
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * get rid of commas, periods, and other characters we don't want
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * TODO do we need this? see above function
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * @param {string} search 
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            */
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            function formatForDirections(search) {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                search = search.replace(/[^\w\s]/gi, '');
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    search = search.replace(/\s+/g, '-');
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return search;
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
    //
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        /**
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * Store a new search location and fire an event to update other widgets
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * @param {string} search 
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           */
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           function updateSearchLocation(search) {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               geolocate(search);
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   localStorage.setItem('location', search);
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       // TODO fire event
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           var event = new CustomEvent('location-update-event', {detail: {location: search, source: placement}});
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               document.dispatchEvent(event);
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
    //
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               /**
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * Handle location updates from other widgets 
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 */
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 function handleUpdateEvent(event) {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if (event.detail.source === placement) { // Don't respond to our own events!
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             return;
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 } else {
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         geolocate(event.detail.location);
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 reloadMap();
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         document.getElementById('map-location').value = event.detail.location;
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
    //
    //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             document.addEventListener('location-update-event', handleUpdateEvent);
