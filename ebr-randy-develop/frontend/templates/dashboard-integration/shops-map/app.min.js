let map,currentLocation,shopMarkerCluster,infoWindow,shopMarkers=[];const placement="map";let NAV_PREFIX="";function initShopsDirectoryMap(){let e=getLocationSearchString();geolocateThenInit(e),setTimeout(function(){document.getElementById("map-location").value=e},1e3)}function getLocationSearchString(){let e=localStorage.getItem("location");return e||""}function geolocateThenInit(e){fetch(DASHBOARD_GEOLOCATE_ENDPOINT+"?location="+e).then(e=>e.json()).then(e=>{initMap(currentLocation=e)})}function compilePopupHtml(e){return'<div class="shop-wrapper"><div class="shop"><div class="shop-title"><h4 id="firstHeading" class="firstHeading">'+e.getProperty("name")+'</h4></div><div class="address">'+e.getProperty("display_address")+'</div><div class="contacts"><a onclick="trackShopClick(event);" data-id="'+e.getProperty("id")+'" data-target="directions" class="btn btn-default contact" href="'+NAV_PREFIX+e.getProperty("latitude")+","+e.getProperty("longitude")+'&amp;ll=" target="_blank">Get Directions <i class="fa fa-location-arrow"></i></a><a onclick="trackShopClick(event);" data-id="'+e.getProperty("id")+'" data-target="website" class="btn btn-default contact" href="'+e.getProperty("website")+'" target="_blank" rel="nofollow" noopener>Visit Website <i class="fa fa-external-link"></i></a><a onclick="trackShopClick(event);" data-id="'+e.getProperty("id")+'" data-target="phone" class="btn btn-default contact" data-phone="'+e.getProperty("phone")+'" id="'+e.getProperty("id")+'-phone" >Get Phone Number <i class="fa fa-phone"></i></a></div><div class="brands">'+compileBrandsHtml(e)+"</div></div></div>"}function compileBrandsHtml(e){let t="";return e.getProperty("brands").forEach(function(e){t=t+'<a class="brand" href="'+getBrandPageUrl(e)+'" target="_blank"><img src="'+e.logo_url+'" class="img-fluid brand-image" alt="'+e.name+'" title="'+e.name+'"></a>'}),t}function getBrandPageUrl(e){return window.location.origin+"/brand/"+e.slug}function initMap(e){map=new google.maps.Map(document.getElementById("map"),{center:e,mapTypeId:"roadmap",zoom:10}),infoWindow=new google.maps.InfoWindow,map.data.loadGeoJson(DASHBOARD_SHOPS_MAP_ENDPOINT,null,function(e){let t=e.map(function(e){var t=e.getGeometry();return new google.maps.Marker({position:t.get(0),icon:SHOPS_ICON_PATH_GOOGLE+"/map-icon.png",html:compilePopupHtml(e),brands:e.getProperty("brands")})});new MarkerClusterer(map,t,{imagePath:window.location.origin+"/dashboard-integration/shops-map/images/m"});for(let e=0;e<t.length;e++){var i=t[e];google.maps.event.addListener(i,"click",function(){infoWindow.setContent(this.html),infoWindow.open(map,this)})}}),map.data.setStyle(function(e){return{icon:SHOPS_ICON_PATH_GOOGLE,visible:!1}})}function trackShopClick(e){if(e.isTrusted){var t=new CustomEvent("shop-click-event",{detail:{id:e.target.dataset.id,placement:placement,target:e.target.dataset.target}});document.dispatchEvent(t),"phone"==e.target.dataset.target&&(document.getElementById(String(e.target.dataset.id)+"-phone").innerHTML=String(e.target.dataset.phone)+' <i class="fa fa-phone"></i>',setTimeout(function(){document.getElementById(String(e.target.dataset.id)+"-phone").href="tel:"+String(e.target.dataset.phone)},500))}}function checkKeyPressed(e){"Enter"===event.key&&reloadMap()}function reloadMap(){let e=document.getElementById("map-location").value;null==e||0==e.length?alert("Please enter a valid location to search for"):(updateSearchLocation(e=formatForApi(e)),geolocateThenInit(e))}function formatForApi(e){return e=e.replace(/\s+/g,"-")}function formatForDirections(e){return e=(e=e.replace(/[^\w\s]/gi,"")).replace(/\s+/g,"-")}function updateSearchLocation(e){localStorage.setItem("location",e);var t=new CustomEvent("location-update-event",{detail:{location:e,source:placement}});document.dispatchEvent(t)}function handleUpdateEvent(e){e.detail.source!==placement&&(geolocateThenInit(e.detail.location),document.getElementById("map-location").value=e.detail.location)}NAV_PREFIX=-1!=navigator.platform.indexOf("iPhone")||-1!=navigator.platform.indexOf("iPad")||-1!=navigator.platform.indexOf("iPod")?"maps://maps.google.com/maps?daddr=":"https://maps.google.com/maps?daddr=",document.addEventListener("location-update-event",handleUpdateEvent);var MarkerClusterer=function(){"use strict";function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function n(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}var r=function(){function e(i,n,r){t(this,e),this.extend(e,google.maps.OverlayView),this.map_=i,this.MARKER_CLUSTER_IMAGE_PATH_="../images/m",this.MARKER_CLUSTER_IMAGE_EXTENSION_="png",this.markers_=[],this.clusters_=[],this.sizes=[53,56,66,78,90],this.styles_=[],this.ready_=!1;var s=r||{};this.zIndex_=s.zIndex||google.maps.Marker.MAX_ZINDEX+1,this.gridSize_=s.gridSize||60,this.minClusterSize_=s.minimumClusterSize||2,this.maxZoom_=s.maxZoom||null,this.styles_=s.styles||[],this.imagePath_=s.imagePath||this.MARKER_CLUSTER_IMAGE_PATH_,this.imageExtension_=s.imageExtension||this.MARKER_CLUSTER_IMAGE_EXTENSION_,this.zoomOnClick_=!0,null!=s.zoomOnClick&&(this.zoomOnClick_=s.zoomOnClick),this.averageCenter_=!1,null!=s.averageCenter&&(this.averageCenter_=s.averageCenter),this.setupStyles_(),this.setMap(i),this.prevZoom_=this.map_.getZoom();var a=this;google.maps.event.addListener(this.map_,"zoom_changed",function(){var e=a.map_.getZoom(),t=a.map_.minZoom||0,i=Math.min(a.map_.maxZoom||100,a.map_.mapTypes[a.map_.getMapTypeId()].maxZoom);e=Math.min(Math.max(e,t),i),a.prevZoom_!=e&&(a.prevZoom_=e,a.resetViewport())}),google.maps.event.addListener(this.map_,"idle",function(){a.redraw()}),n&&(n.length||Object.keys(n).length)&&this.addMarkers(n,!1)}return n(e,[{key:"extend",value:function(e,t){return function(e){for(var t in e.prototype)this.prototype[t]=e.prototype[t];return this}.apply(e,[t])}},{key:"onAdd",value:function(){this.setReady_(!0)}},{key:"draw",value:function(){}},{key:"setupStyles_",value:function(){if(!this.styles_.length)for(var e,t=0;e=this.sizes[t];t++)this.styles_.push({url:this.imagePath_+(t+1)+"."+this.imageExtension_,height:e,width:e})}},{key:"fitMapToMarkers",value:function(){for(var e,t=this.getMarkers(),i=new google.maps.LatLngBounds,n=0;e=t[n];n++)i.extend(e.getPosition());this.map_.fitBounds(i)}},{key:"setZIndex",value:function(e){this.zIndex_=e}},{key:"getZIndex",value:function(){return this.zIndex_}},{key:"setStyles",value:function(e){this.styles_=e}},{key:"getStyles",value:function(){return this.styles_}},{key:"isZoomOnClick",value:function(){return this.zoomOnClick_}},{key:"isAverageCenter",value:function(){return this.averageCenter_}},{key:"getMarkers",value:function(){return this.markers_}},{key:"getTotalMarkers",value:function(){return this.markers_.length}},{key:"setMaxZoom",value:function(e){this.maxZoom_=e}},{key:"getMaxZoom",value:function(){return this.maxZoom_}},{key:"calculator_",value:function(e,t){for(var i=0,n=e.length,r=n;0!==r;)r=parseInt(r/10,10),i++;return{text:n,index:i=Math.min(i,t)}}},{key:"setCalculator",value:function(e){this.calculator_=e}},{key:"getCalculator",value:function(){return this.calculator_}},{key:"addMarkers",value:function(e,t){if(e.length)for(var i,n=0;i=e[n];n++)this.pushMarkerTo_(i);else if(Object.keys(e).length)for(var r in e)this.pushMarkerTo_(e[r]);t||this.redraw()}},{key:"pushMarkerTo_",value:function(e){if(e.isAdded=!1,e.draggable){var t=this;google.maps.event.addListener(e,"dragend",function(){e.isAdded=!1,t.repaint()})}this.markers_.push(e)}},{key:"addMarker",value:function(e,t){this.pushMarkerTo_(e),t||this.redraw()}},{key:"removeMarker_",value:function(e){var t=-1;if(this.markers_.indexOf)t=this.markers_.indexOf(e);else for(var i,n=0;i=this.markers_[n];n++)if(i==e){t=n;break}return-1!=t&&(e.setMap(null),this.markers_.splice(t,1),!0)}},{key:"removeMarker",value:function(e,t){var i=this.removeMarker_(e);return!(t||!i||(this.resetViewport(),this.redraw(),0))}},{key:"removeMarkers",value:function(e,t){for(var i,n=e===this.getMarkers()?e.slice():e,r=!1,s=0;i=n[s];s++){var a=this.removeMarker_(i);r=r||a}if(!t&&r)return this.resetViewport(),this.redraw(),!0}},{key:"setReady_",value:function(e){this.ready_||(this.ready_=e,this.createClusters_())}},{key:"getTotalClusters",value:function(){return this.clusters_.length}},{key:"getMap",value:function(){return this.map_}},{key:"setMap",value:function(e){this.map_=e}},{key:"getGridSize",value:function(){return this.gridSize_}},{key:"setGridSize",value:function(e){this.gridSize_=e}},{key:"getMinClusterSize",value:function(){return this.minClusterSize_}},{key:"setMinClusterSize",value:function(e){this.minClusterSize_=e}},{key:"getExtendedBounds",value:function(e){var t=this.getProjection(),i=new google.maps.LatLng(e.getNorthEast().lat(),e.getNorthEast().lng()),n=new google.maps.LatLng(e.getSouthWest().lat(),e.getSouthWest().lng()),r=t.fromLatLngToDivPixel(i);r.x+=this.gridSize_,r.y-=this.gridSize_;var s=t.fromLatLngToDivPixel(n);s.x-=this.gridSize_,s.y+=this.gridSize_;var a=t.fromDivPixelToLatLng(r),o=t.fromDivPixelToLatLng(s);return e.extend(a),e.extend(o),e}},{key:"isMarkerInBounds_",value:function(e,t){return t.contains(e.getPosition())}},{key:"clearMarkers",value:function(){this.resetViewport(!0),this.markers_=[]}},{key:"resetViewport",value:function(e){for(var t,i=0;t=this.clusters_[i];i++)t.remove();for(var n,r=0;n=this.markers_[r];r++)n.isAdded=!1,e&&n.setMap(null);this.clusters_=[]}},{key:"repaint",value:function(){var e=this.clusters_.slice();this.clusters_.length=0,this.resetViewport(),this.redraw(),setTimeout(function(){for(var t,i=0;t=e[i];i++)t.remove()},0)}},{key:"redraw",value:function(){this.createClusters_()}},{key:"distanceBetweenPoints_",value:function(e,t){if(!e||!t)return 0;var i=(t.lat()-e.lat())*Math.PI/180,n=(t.lng()-e.lng())*Math.PI/180,r=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e.lat()*Math.PI/180)*Math.cos(t.lat()*Math.PI/180)*Math.sin(n/2)*Math.sin(n/2);return 2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r))*6371}},{key:"addToClosestCluster_",value:function(e){for(var t,i=4e4,n=null,r=0;t=this.clusters_[r];r++){var a=t.getCenter();if(a){var o=this.distanceBetweenPoints_(a,e.getPosition());o<i&&(i=o,n=t)}}if(n&&n.isMarkerInClusterBounds(e))n.addMarker(e);else{var l=new s(this);l.addMarker(e),this.clusters_.push(l)}}},{key:"createClusters_",value:function(){if(this.ready_)for(var e,t=new google.maps.LatLngBounds(this.map_.getBounds().getSouthWest(),this.map_.getBounds().getNorthEast()),i=this.getExtendedBounds(t),n=0;e=this.markers_[n];n++)!e.isAdded&&this.isMarkerInBounds_(e,i)&&this.addToClosestCluster_(e)}}]),e}(),s=function(){function e(i){t(this,e),this.markerClusterer_=i,this.map_=i.getMap(),this.gridSize_=i.getGridSize(),this.minClusterSize_=i.getMinClusterSize(),this.averageCenter_=i.isAverageCenter(),this.center_=null,this.markers_=[],this.bounds_=null,this.clusterIcon_=new a(this,i.getStyles(),i.getGridSize())}return n(e,[{key:"isMarkerAlreadyAdded",value:function(e){if(this.markers_.indexOf)return-1!=this.markers_.indexOf(e);for(var t,i=0;t=this.markers_[i];i++)if(t==e)return!0;return!1}},{key:"addMarker",value:function(e){if(this.isMarkerAlreadyAdded(e))return!1;if(this.center_){if(this.averageCenter_){var t=this.markers_.length+1,i=(this.center_.lat()*(t-1)+e.getPosition().lat())/t,n=(this.center_.lng()*(t-1)+e.getPosition().lng())/t;this.center_=new google.maps.LatLng(i,n),this.calculateBounds_()}}else this.center_=e.getPosition(),this.calculateBounds_();e.isAdded=!0,this.markers_.push(e);var r=this.markers_.length;if(r<this.minClusterSize_&&e.getMap()!=this.map_&&e.setMap(this.map_),r==this.minClusterSize_)for(var s=0;s<r;s++)this.markers_[s].setMap(null);return r>=this.minClusterSize_&&e.setMap(null),this.updateIcon(),!0}},{key:"getMarkerClusterer",value:function(){return this.markerClusterer_}},{key:"getBounds",value:function(){for(var e,t=new google.maps.LatLngBounds(this.center_,this.center_),i=this.getMarkers(),n=0;e=i[n];n++)t.extend(e.getPosition());return t}},{key:"remove",value:function(){this.clusterIcon_.remove(),this.markers_.length=0,delete this.markers_}},{key:"getSize",value:function(){return this.markers_.length}},{key:"getMarkers",value:function(){return this.markers_}},{key:"getCenter",value:function(){return this.center_}},{key:"calculateBounds_",value:function(){var e=new google.maps.LatLngBounds(this.center_,this.center_);this.bounds_=this.markerClusterer_.getExtendedBounds(e)}},{key:"isMarkerInClusterBounds",value:function(e){return this.bounds_.contains(e.getPosition())}},{key:"getMap",value:function(){return this.map_}},{key:"updateIcon",value:function(){var e=this.map_.getZoom(),t=this.markerClusterer_.getMaxZoom();if(t&&e>t)for(var i,n=0;i=this.markers_[n];n++)i.setMap(this.map_);else if(this.markers_.length<this.minClusterSize_)this.clusterIcon_.hide();else{var r=this.markerClusterer_.getStyles().length,s=this.markerClusterer_.getCalculator()(this.markers_,r);this.clusterIcon_.setCenter(this.center_),this.clusterIcon_.setSums(s),this.clusterIcon_.show()}}}]),e}(),a=function(){function i(e,n,r){t(this,i),e.getMarkerClusterer().extend(i,google.maps.OverlayView),this.styles_=n,this.padding_=r||0,this.cluster_=e,this.center_=null,this.map_=e.getMap(),this.div_=null,this.sums_=null,this.visible_=!1,this.setMap(this.map_)}return n(i,[{key:"triggerClusterClick",value:function(){var e=this.cluster_.getBounds(),t=this.cluster_.getMarkerClusterer();google.maps.event.trigger(t.map_,"clusterclick",this.cluster_),t.isZoomOnClick()&&(this.map_.fitBounds(e),this.map_.setCenter(e.getCenter()))}},{key:"onAdd",value:function(){if(this.div_=document.createElement("DIV"),this.visible_){var e=this.getPosFromLatLng_(this.center_);this.div_.style.cssText=this.createCss(e),this.div_.innerHTML=this.sums_.text}this.getPanes().overlayMouseTarget.appendChild(this.div_);var t=this;google.maps.event.addDomListener(this.div_,"click",function(){t.triggerClusterClick()})}},{key:"getPosFromLatLng_",value:function(e){var t=this.getProjection().fromLatLngToDivPixel(e);return t.x-=parseInt(this.width_/2,10),t.y-=parseInt(this.height_/2,10),t}},{key:"draw",value:function(){if(this.visible_){var e=this.getPosFromLatLng_(this.center_);this.div_.style.top=e.y+"px",this.div_.style.left=e.x+"px"}}},{key:"hide",value:function(){this.div_&&(this.div_.style.display="none"),this.visible_=!1}},{key:"show",value:function(){if(this.div_){var e=this.getPosFromLatLng_(this.center_);this.div_.style.cssText=this.createCss(e),this.div_.style.display=""}this.visible_=!0}},{key:"remove",value:function(){this.setMap(null)}},{key:"onRemove",value:function(){this.div_&&this.div_.parentNode&&(this.hide(),this.div_.parentNode.removeChild(this.div_),this.div_=null)}},{key:"setSums",value:function(e){this.sums_=e,this.text_=e.text,this.index_=e.index,this.div_&&(this.div_.innerHTML=e.text),this.useStyle()}},{key:"useStyle",value:function(){var e=Math.max(0,this.sums_.index-1);e=Math.min(this.styles_.length-1,e);var t=this.styles_[e];this.url_=t.url,this.height_=t.height,this.width_=t.width,this.textColor_=t.textColor,this.anchor_=t.anchor,this.textSize_=t.textSize,this.backgroundPosition_=t.backgroundPosition}},{key:"setCenter",value:function(e){this.center_=e}},{key:"createCss",value:function(t){var i=[];i.push("z-index:"+this.cluster_.markerClusterer_.getZIndex()+";"),i.push("background-image:url("+this.url_+");");var n=this.backgroundPosition_?this.backgroundPosition_:"0 0";i.push("background-position:"+n+";"),"object"===e(this.anchor_)?("number"==typeof this.anchor_[0]&&this.anchor_[0]>0&&this.anchor_[0]<this.height_?i.push("height:"+(this.height_-this.anchor_[0])+"px; padding-top:"+this.anchor_[0]+"px;"):i.push("height:"+this.height_+"px; line-height:"+this.height_+"px;"),"number"==typeof this.anchor_[1]&&this.anchor_[1]>0&&this.anchor_[1]<this.width_?i.push("width:"+(this.width_-this.anchor_[1])+"px; padding-left:"+this.anchor_[1]+"px;"):i.push("width:"+this.width_+"px; text-align:center;")):i.push("height:"+this.height_+"px; line-height:"+this.height_+"px; width:"+this.width_+"px; text-align:center;");var r=this.textColor_?this.textColor_:"black",s=this.textSize_?this.textSize_:11;return i.push("cursor:pointer; top:"+t.y+"px; left:"+t.x+"px; color:"+r+"; position:absolute; font-size:"+s+"px; font-family:Arial,sans-serif; font-weight:bold"),i.join("")}}]),i}();return r}();